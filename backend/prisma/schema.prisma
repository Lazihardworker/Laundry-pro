// Prisma Schema for LaundryPro

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// USERS TABLE
// ============================================
model User {
  id                String   @id @default(uuid())
  phone             String   @unique
  email             String?  @unique
  passwordHash      String   @map("password_hash")
  firstName         String   @map("first_name")
  lastName          String   @map("last_name")
  role              UserRole @default(CUSTOMER)

  profilePictureUrl String?  @map("profile_picture_url")
  address           Json?

  notificationPreferences Json @default("{\"sms\": true, \"email\": true, \"whatsapp\": false}") @map("notification_preferences")

  isActive    Boolean  @default(true) @map("is_active")
  isVerified  Boolean  @default(false) @map("is_verified")
  lastLoginAt DateTime? @map("last_login_at")

  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  orders           Order[]
  staffProfile     Staff?
  issues           Issue[]
  reviews          Review[]
  notifications    Notification[]
  activityLogs     ActivityLog[]
  payments         Payment[]
  subscriptions    Subscription[]
  resolvedIssues   Issue[]         @relation("ResolvedBy")

  _count           Int

  @@map("users")
}

enum UserRole {
  CUSTOMER
  STAFF
  ADMIN
}

// ============================================
// BRANCHES TABLE
// ============================================
model Branch {
  id           String   @id @default(uuid())
  name         String
  address      String
  city         String
  state        String
  lga          String?
  coordinates  Json?
  phone        String
  email        String?

  openingHours Json?   @map("opening_hours")
  isActive     Boolean @default(true) @map("is_active")

  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  // Relations
  services     Service[]
  orders       Order[]
  staff        Staff[]

  @@map("branches")
}

// ============================================
// SERVICES TABLE
// ============================================
model Service {
  id              String        @id @default(uuid())
  name            String
  category        ServiceCategory
  serviceType     String        @map("service_type")

  basePrice       Decimal       @map("base_price") @db.Decimal(10, 2)
  pricingUnit     String        @map("pricing_unit")

  estimatedHours  Int           @map("estimated_hours")
  isExpress       Boolean       @default(false) @map("is_express")

  branchId        String?       @map("branch_id")
  branch          Branch?       @relation(fields: [branchId], references: [id])

  isActive        Boolean       @default(true) @map("is_active")
  description     String?       @db.Text
  careInstructions String?      @map("care_instructions") @db.Text

  createdAt       DateTime      @default(now()) @map("created_at")
  updatedAt       DateTime      @updatedAt @map("updated_at")

  // Relations
  orders          Order[]

  @@map("services")
}

enum ServiceCategory {
  BASIC
  PREMIUM
  EXPRESS
  CORPORATE
}

// ============================================
// ORDERS TABLE
// ============================================
model Order {
  id                    String           @id @default(uuid())
  orderNumber           String           @unique @map("order_number")

  customerId            String           @map("customer_id")
  customer              User             @relation(fields: [customerId], references: [id])

  branchId              String           @map("branch_id")
  branch                Branch           @relation(fields: [branchId], references: [id])

  serviceId             String           @map("service_id")
  service               Service          @relation(fields: [serviceId], references: [id])

  assignedStaffId       String?          @map("assigned_staff_id")
  assignedStaff         User?            @relation(fields: [assignedStaffId], references: [id])

  status                OrderStatus      @default(PENDING)

  pickupType            String           @map("pickup_type")
  pickupAddress         Json?            @map("pickup_address")
  pickupScheduledFor    DateTime?        @map("pickup_scheduled_for")
  pickupCompletedAt     DateTime?        @map("pickup_completed_at")

  deliveryScheduledFor  DateTime?        @map("delivery_scheduled_for")
  deliveryAddress       Json?            @map("delivery_address")
  deliveryCompletedAt   DateTime?        @map("delivery_completed_at")

  subtotal              Decimal          @default(0) @db.Decimal(10, 2)
  deliveryFee           Decimal          @default(0) @map("delivery_fee") @db.Decimal(10, 2)
  expressFee            Decimal          @default(0) @map("express_fee") @db.Decimal(10, 2)
  discount              Decimal          @default(0) @db.Decimal(10, 2)
  totalAmount           Decimal          @map("total_amount") @db.Decimal(10, 2)

  isExpress             Boolean          @default(false) @map("is_express")
  promisedBy            DateTime?        @map("promised_by")

  notes                 String?          @db.Text
  internalNotes         String?          @map("internal_notes") @db.Text
  priorityScore         Int              @default(0) @map("priority_score")

  createdAt             DateTime         @default(now()) @map("created_at")
  updatedAt             DateTime         @updatedAt @map("updated_at")
  completedAt           DateTime?        @map("completed_at")

  // Relations
  items                 OrderItem[]
  payments              Payment[]
  issues                Issue[]
  notifications         Notification[]
  reviews               Review[]
  activityLogs          ActivityLog[]

  @@map("orders")
}

enum OrderStatus {
  PENDING
  RECEIVED
  WASHING
  IRONING
  READY
  DELIVERED
  CANCELLED
}

// ============================================
// ORDER_ITEMS TABLE
// ============================================
model OrderItem {
  id               String    @id @default(uuid())
  orderId          String    @map("order_id")
  order            Order     @relation(fields: [orderId], references: [id], onDelete: Cascade)

  itemName         String    @map("item_name")
  quantity         Int       @default(1)
  unitPrice        Decimal   @map("unit_price") @db.Decimal(10, 2)
  totalPrice       Decimal   @map("total_price") @db.Decimal(10, 2)

  color            String?
  brand            String?
  size             String?
  fabricType       String?   @map("fabric_type")

  conditionReceived String?  @map("condition_received")
  conditionReturned  String?  @map("condition_returned")
  imageUrls        String[]  @map("image_urls")

  createdAt        DateTime  @default(now()) @map("created_at")

  @@map("order_items")
}

// ============================================
// PAYMENTS TABLE
// ============================================
model Payment {
  id                String        @id @default(uuid())
  orderId           String        @map("order_id")
  order             Order         @relation(fields: [orderId], references: [id])

  amount            Decimal       @db.Decimal(10, 2)

  paymentMethod     String        @map("payment_method")
  paymentProvider   String?       @map("payment_provider")

  providerReference String?       @map("provider_reference")
  providerResponse  Json?         @map("provider_response")

  status            PaymentStatus @default(PENDING)

  paidAt            DateTime?     @map("paid_at")
  createdAt         DateTime      @default(now()) @map("created_at")
  updatedAt         DateTime      @updatedAt @map("updated_at")

  customer          User          @relation(fields: [orderId], references: [id])

  @@map("payments")
}

enum PaymentStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  REFUNDED
}

// ============================================
// STAFF TABLE
// ============================================
model Staff {
  id              String   @id @default(uuid())
  userId          String   @unique @map("user_id")
  user            User     @relation(fields: [userId], references: [id])

  branchId        String   @map("branch_id")
  branch          Branch   @relation(fields: [branchId], references: [id])

  role            String
  permissions     Json?

  employeeId      String?  @unique @map("employee_id")
  hireDate        DateTime? @map("hire_date") @db.Date
  salary          Decimal? @db.Decimal(10, 2)
  isActive        Boolean  @default(true) @map("is_active")

  totalOrdersHandled Int    @default(0) @map("total_orders_handled")
  averageRating    Decimal? @map("average_rating") @db.Decimal(3, 2)

  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")

  @@map("staff")
}

// ============================================
// ISSUES TABLE
// ============================================
model Issue {
  id              String      @id @default(uuid())
  orderId         String?     @map("order_id")
  order           Order?      @relation(fields: [orderId], references: [id])

  reporterId      String      @map("reporter_id")
  reporter        User        @relation(fields: [reporterId], references: [id])

  issueType       String      @map("issue_type")
  severity        String

  description     String      @db.Text
  imageUrls       String[]    @map("image_urls")

  status          IssueStatus @default(OPEN)

  resolutionNotes String?     @map("resolution_notes") @db.Text
  resolvedById    String?     @map("resolved_by_id")
  resolvedBy      User?       @relation("ResolvedBy", fields: [resolvedById], references: [id])
  resolvedAt      DateTime?   @map("resolved_at")

  compensationAmount Decimal? @map("compensation_amount") @db.Decimal(10, 2)
  compensationType   String?  @map("compensation_type")

  createdAt       DateTime    @default(now()) @map("created_at")
  updatedAt       DateTime    @updatedAt @map("updated_at")

  @@map("issues")
}

enum IssueStatus {
  OPEN
  INVESTIGATING
  RESOLVED
  CLOSED
}

// ============================================
// NOTIFICATIONS TABLE
// ============================================
model Notification {
  id          String   @id @default(uuid())
  userId      String   @map("user_id")
  user        User     @relation(fields: [userId], references: [id])

  orderId     String?  @map("order_id")
  order       Order?   @relation(fields: [orderId], references: [id])

  type        String
  title       String
  message     String   @db.Text

  channels    String[] @default(["in_app"])

  isRead      Boolean  @default(false) @map("is_read")
  sentAt      DateTime? @map("sent_at")
  readAt      DateTime? @map("read_at")

  data        Json?

  createdAt   DateTime @default(now()) @map("created_at")

  @@map("notifications")
}

// ============================================
// SUBSCRIPTIONS TABLE
// ============================================
model Subscription {
  id              String            @id @default(uuid())
  customerId      String            @map("customer_id")
  customer        User              @relation(fields: [customerId], references: [id])

  planName        String            @map("plan_name")
  planType        String            @map("plan_type")

  maxItemsPerMonth Int?             @map("max_items_per_month")
  maxPickupsPerMonth Int?           @map("max_pickups_per_month")

  monthlyPrice    Decimal           @map("monthly_price") @db.Decimal(10, 2)

  startDate       DateTime          @map("start_date") @db.Date
  endDate         DateTime?         @map("end_date") @db.Date
  billingCycle    String            @map("billing_cycle")

  status          SubscriptionStatus @default(ACTIVE)

  isAutoRenew     Boolean           @default(true) @map("is_auto_renew")

  createdAt       DateTime          @default(now()) @map("created_at")
  updatedAt       DateTime          @updatedAt @map("updated_at")

  @@map("subscriptions")
}

enum SubscriptionStatus {
  ACTIVE
  PAUSED
  CANCELLED
  EXPIRED
}

// ============================================
// REVIEWS TABLE
// ============================================
model Review {
  id              String   @id @default(uuid())
  orderId         String   @unique @map("order_id")
  order           Order    @relation(fields: [orderId], references: [id])

  customerId      String   @map("customer_id")
  customer        User     @relation(fields: [customerId], references: [id])

  staffId         String?  @map("staff_id")
  staff           User?    @relation(fields: [staffId], references: [id])

  rating          Int

  serviceQuality  Int?     @map("service_quality")
  timeliness      Int?
  communication   Int?

  comment         String?  @db.Text

  responseText    String?  @map("response_text") @db.Text
  respondedBy     String?  @map("responded_by_id")
  respondedAt     DateTime? @map("responded_at")

  isVisible       Boolean  @default(true) @map("is_visible")

  createdAt       DateTime @default(now()) @map("created_at")

  @@map("reviews")
}

// ============================================
// ACTIVITY_LOGS TABLE
// ============================================
model ActivityLog {
  id          String   @id @default(uuid())
  userId      String?  @map("user_id")
  user        User?    @relation(fields: [userId], references: [id])

  orderId     String?  @map("order_id")
  order       Order?   @relation(fields: [orderId], references: [id])

  action      String
  entityType  String   @map("entity_type")
  entityId    String   @map("entity_id")

  oldValues   Json?    @map("old_values")
  newValues   Json?    @map("new_values")
  description String?  @db.Text

  ipAddress   String?  @map("ip_address")
  userAgent   String?  @map("user_agent")

  createdAt   DateTime @default(now()) @map("created_at")

  @@map("activity_logs")
}
